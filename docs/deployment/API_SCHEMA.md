# ACE Inference API Schema

The ACE Container App exposes a generic JSON interface under the `/intervene` endpoint. This allows arbitrary causal discovery pipelines or cloud orchestrators to dynamically inject Structural Causal Models (SCMs) and receive strategic interventions without needing to write custom Python bindings.

## Endpoint: `POST /intervene`

Accepts a JSON payload describing the DAG structure and current losses, and returns a JSON object containing the recommended intervention.

### Request Input Schema (`InterventionRequest`)

The API requires the structural definition of the SCM along with the current evaluated mechanism losses for the nodes. 

```json
{
  "scm": {
    "nodes": ["X1", "X2", "X3"],
    "edges": [
      {"source": "X1", "target": "X2"},
      {"source": "X2", "target": "X3"}
    ]
  },
  "node_losses": {
    "X1": 0.05,
    "X2": 1.20,
    "X3": 0.10
  },
  "intervention_history": ["X1", "X1"] // Optional
}
```

#### Field Definitions
- **`scm`**: The graph topology.
  - **`nodes`** *(List[str])* : Canonical names for all variables in the system.
  - **`edges`** *(List[Object])* : Directed edges representing assumed causal links. The API validates that this forms a Directed Acyclic Graph (DAG).
- **`node_losses`** *(Dict[str, float])* : Essential for inference. Maps each node to its current mechanism evaluation error (Mean Squared Error). The ACE LLM Policy uses this to calculate which node mechanism is failing so it can generate an intervention to gather more data on it.
- **`intervention_history`** *(List[str], Optional)* : A chronological list of nodes that have recently been intervened on. ACE uses this to penalize or avoid getting stuck in loops sampling the same node.
- **`value_min`** *(float, Optional)* : Defaults to `-5.0`. Lower bound for the continuous value generated by the DPO model.
- **`value_max`** *(float, Optional)* : Defaults to `5.0`. Upper bound for the continuous value.

---

### Response Output Schema (`InterventionResponse`)

The API responds with the optimal intervention generated by the underlying Qwen2.5-1.5B DPO policy, translated back into a generic format actionable by any environment simulator.

```json
{
  "command": "DO X2 = 1.6241",
  "target": "X2",
  "value": 1.6241,
  "samples": 200
}
```

#### Field Definitions
- **`command`** *(str)* : The raw canonical string generated by the LLM (e.g. `DO NODE = VALUE`).
- **`target`** *(str)* : The canonical name of the node that should be intervened upon.
- **`value`** *(float)* : The exact, continuous scalar numeric value the target node should be set to (hard intervention).
- **`samples`** *(int)* : The recommended number of observational samples to collect under this intervention. (Statically defaults to `200` in the current ACE implementation).

### Error Handling
The container provides robust error catching:
- **`HTTP 400 Bad Request`**: Is returned if the generic SCM provided in the JSON violates the directed acyclic graph assumption.
- **`HTTP 503 Service Unavailable`**: Is returned if the LLM weights have not finished loading yet.
- **`HTTP 500 Internal Server Error`**: Is returned if the LLM output deviates from the vocabulary and fails to parse into the `InterventionResponse` dictionary.
